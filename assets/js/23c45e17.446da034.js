(self.webpackChunkhhow_09_github_io=self.webpackChunkhhow_09_github_io||[]).push([[4734],{3905:function(e,t,a){"use strict";a.d(t,{Zo:function(){return m},kt:function(){return d}});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=r.createContext({}),u=function(e){var t=r.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},m=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),p=u(a),d=n,h=p["".concat(s,".").concat(d)]||p[d]||c[d]||i;return a?r.createElement(h,o(o({ref:t},m),{},{components:a})):r.createElement(h,o({ref:t},m))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,o=new Array(i);o[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:n,o[1]=l;for(var u=2;u<i;u++)o[u]=a[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}p.displayName="MDXCreateElement"},5969:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return l},metadata:function(){return s},toc:function(){return u},default:function(){return c}});var r=a(2122),n=a(9756),i=(a(7294),a(3905)),o=["components"],l={},s={unversionedId:"js/js-immutability",id:"js/js-immutability",isDocsHomePage:!1,title:"Immutability",description:"Introduction",source:"@site/docs/js/2-js-immutability.md",sourceDirName:"js",slug:"/js/js-immutability",permalink:"/js/js-immutability",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/js/2-js-immutability.md",version:"current",sidebarPosition:2,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Closure",permalink:"/js/js-closure"},next:{title:"Javascript Dev Notes",permalink:"/js/js-dev-note"}},u=[{value:"Introduction",id:"introduction",children:[]},{value:"Benefits of Immutability",id:"benefits-of-immutability",children:[]},{value:"How immutability boosts React performance",id:"how-immutability-boosts-react-performance",children:[{value:"Background",id:"background",children:[]},{value:"When we want to avoid unnecessary re-render",id:"when-we-want-to-avoid-unnecessary-re-render",children:[]}]},{value:"How to implement immutability?",id:"how-to-implement-immutability",children:[{value:"Persistent data structures",id:"persistent-data-structures",children:[]},{value:"Spread Operator (ES6) (without Library)",id:"spread-operator-es6-without-library",children:[]}]},{value:"Immutable.js library",id:"immutablejs-library",children:[{value:"Behind the scene",id:"behind-the-scene",children:[]},{value:"When to use immutable library?",id:"when-to-use-immutable-library",children:[]}]},{value:"Reference",id:"reference",children:[]}],m={toc:u};function c(e){var t=e.components,a=(0,n.Z)(e,o);return(0,i.kt)("wrapper",(0,r.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Javascript reference data type ",(0,i.kt)("inlineCode",{parentName:"li"},"Object")," has mutable characteristics. The benefit of mutability is memory-saving. However in frontend scenario, the disadvantage of side effect often outweigh the advantage."),(0,i.kt)("li",{parentName:"ul"},"Without immutability, you might have to pass an object around between different scopes, and you do not know beforehand if and when the object will be changed. The code becomes unpredictable and is difficult to debug."),(0,i.kt)("li",{parentName:"ul"},"Immutability in Javascript means we cannot update variable by reference. Whenever we want to update a variable, we create a new reference.")),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"benefits-of-immutability"},"Benefits of Immutability"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"Predictability"),"\nMutation hides change, which create (unexpected) side effects, which can cause nasty bugs. When you enforce immutability you can keep your application architecture and mental model simple.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"Mutation Tracking"),"\nImmutability allows you to optimize your application by making use of reference and value equality. This makes it really easy to see if anything has changed.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"Boost performance (indirectly)"),"\nWhen facing mutable data structure, we want to know if object change by iterating through all properties. In contrast, facing immutable data structure, we only have to check equality of reference.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Reduce the need of lock when ",(0,i.kt)("inlineCode",{parentName:"p"},"concurrent programming")," (not completely)\nThe core problem of multi thread programming is race condition. We need to ensure atomic characteristic inside critical operation by some methods such as lock."))),(0,i.kt)("h2",{id:"how-immutability-boosts-react-performance"},"How immutability boosts React performance"),(0,i.kt)("h3",{id:"background"},"Background"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"React maintains an internal representation of the UI, the so-called ",(0,i.kt)("inlineCode",{parentName:"li"},"virtual DOM"),"."),(0,i.kt)("li",{parentName:"ul"},"When a property or the state of a component changes, this virtual DOM is updated to reflect those changes. Manipulating the virtual DOM is easier and faster because nothing is changed in the UI."),(0,i.kt)("li",{parentName:"ul"},"Then, React compares the virtual DOM with a version before the update in order to know what changed. This is the reconciliation process.")),(0,i.kt)("h3",{id:"when-we-want-to-avoid-unnecessary-re-render"},"When we want to avoid unnecessary re-render"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"React in default re-render components whenever ",(0,i.kt)("inlineCode",{parentName:"li"},"state")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"props")," change."),(0,i.kt)("li",{parentName:"ul"},"Sometimes knowing what changes could be very difficult when props is deep nested object."),(0,i.kt)("li",{parentName:"ul"},"If the props are guaranteed the immutability characteristic, we can simply know ",(0,i.kt)("inlineCode",{parentName:"li"},"wether the props change")," by performing simple equality check without dive into nested object and compare values respectively.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"class MyComponent extends Component {\n  // ...\n  shouldComponentUpdate(nextProps, nextState) {\n    if (this.props !== nextProps) {\n      return true;\n    }\n    return false;\n  }\n  // ...\n}\n")),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"how-to-implement-immutability"},"How to implement immutability?"),(0,i.kt)("p",null,"To clarify before we start, when talking about ",(0,i.kt)("inlineCode",{parentName:"p"},"create a new reference when updating a variable"),", we do not refer to performs deep copy operation ",(0,i.kt)("inlineCode",{parentName:"p"},"JSON.parse(JSON.stringify(obj))")," because it simply recreate all properties even of those not changed. This actually hurt performance."),(0,i.kt)("h3",{id:"persistent-data-structures"},"Persistent data structures"),(0,i.kt)("p",null,"Persistent data structures enforces a constraint that all operations will return a newer version of that data structure and ",(0,i.kt)("inlineCode",{parentName:"p"},"keep the original structure intact"),",e.g. reusing existing nodes as much as possible."),(0,i.kt)("h3",{id:"spread-operator-es6-without-library"},"Spread Operator (ES6) (without Library)"),(0,i.kt)("p",null,"When perform state update in React, we often need to do operations such as ",(0,i.kt)("inlineCode",{parentName:"p"},"modify a properties in Object"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"append element to array"),", and",(0,i.kt)("inlineCode",{parentName:"p"},"insert array"),". Thanks to ",(0,i.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Operators/Spread_syntax"},"Spread Operator")," in Javascript ES6, we can only update the specific property and keep other references intact. Rect officially recommend this way to do state update, ",(0,i.kt)("a",{parentName:"p",href:"https://reactjs.org/docs/optimizing-performance.html#the-power-of-not-mutating-data"},"The Power Of Not Mutating Data"),"."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"modify a properties in Object")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'const [myData, setMyData] = useState({ myName: "Howard", myPhoneNum: "0912345678" });\nsetMyData((prevState) => {\n  return { ...prevState, myName: "Cool Howard" };\n});\n// { myName: "Cool Howard", myPhoneNum: "0912345678" }\n')),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"append element to array")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'const [sentence, setSentence] = useState(["You", "are", "an", "awesome"]);\nsetSentence((prevState) => [...prevState, "programmer"]);\n// ["You", "are", "an","awesome", "programmer"]\n')),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"insert array")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'const [sentence, setSentence] = useState(["You", "are", "awesome", "programmer"]);\nsetSentence((prevState) => [...prevState.slice(0, 2), "an", ...prevState.slice(2)]);\n// ["You", "are", "an","awesome", "programmer"]\n')),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"immutablejs-library"},(0,i.kt)("a",{parentName:"h2",href:"https://immutable-js.github.io/immutable-js/"},"Immutable.js")," library"),(0,i.kt)("p",null,"Nowadays, ",(0,i.kt)("a",{parentName:"p",href:"https://immutable-js.github.io/immutable-js/"},"Immutable.js")," is the most famous library."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"It implements fully persistent data structures including: ",(0,i.kt)("inlineCode",{parentName:"li"},"List"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"Stack"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"Map"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"OrderedMap"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"Set"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"OrderedSet")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"Record"),"."),(0,i.kt)("li",{parentName:"ul"},"It provides mutative API to update data in an ",(0,i.kt)("inlineCode",{parentName:"li"},"efficient")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"immutable")," way.")),(0,i.kt)("h3",{id:"behind-the-scene"},"Behind the scene"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://hackernoon.com/how-immutable-data-structures-e-g-immutable-js-are-optimized-using-structural-sharing-e4424a866d56"},"How Immutable Data Structures (E.g. Immutable.js) are Optimized")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://medium.com/@dtinth/immutable-js-persistent-data-structures-and-structural-sharing-6d163fbd73d2"},"Immutable.js, persistent data structures and structural sharing"))),(0,i.kt)("p",null,"These articles illustrated how to implement object into immutable as well as persistent data structure using ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Trie"},"Trie")),(0,i.kt)("h3",{id:"when-to-use-immutable-library"},"When to use immutable library?"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Please don\u2019t take this article to mean \u201cyou should always use Immutable.js.\u201d No, I\u2019m just trying to highlight its benefits in this article and explain why it\u2019s recommended a lot.")),(0,i.kt)("p",null,"There are still drawbacks using immutable library:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"We will couple the most basic data structure with a library."),(0,i.kt)("li",{parentName:"ol"},"The size of package increase."),(0,i.kt)("li",{parentName:"ol"},"When frequently communicating with server, we will have to convert the data structure between library and native Javascript.")),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"reference"},"Reference"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://archive.jlongster.com/Using-Immutable-Data-Structures-in-JavaScript"},"Immutable Data Structures and JavaScript")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://blog.logrocket.com/immutability-in-react-ebe55253a1cc/"},"Immutability in React: There\u2019s nothing wrong with mutating objects")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://immutable-js.github.io/immutable-js/"},"Immutable.js")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/camsong/blog/issues/3"},"Immutable \u8be6\u89e3\u53ca React \u4e2d\u5b9e\u8df5 #3")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://medium.com/@dtinth/immutable-js-persistent-data-structures-and-structural-sharing-6d163fbd73d2"},"Immutable.js, persistent data structures and structural sharing")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://fuzhe1989.github.io/2017/11/07/persistent-data-structure/"},"Persistent Data Structure"))))}c.isMDXComponent=!0}}]);