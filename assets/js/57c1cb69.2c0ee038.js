(self.webpackChunkhhow_09_github_io=self.webpackChunkhhow_09_github_io||[]).push([[1221],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return c},kt:function(){return h}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var u=r.createContext({}),l=function(e){var t=r.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=l(e.components);return r.createElement(u.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,u=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=l(n),h=o,m=p["".concat(u,".").concat(h)]||p[h]||d[h]||a;return n?r.createElement(m,i(i({ref:t},c),{},{components:n})):r.createElement(m,i({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=p;var s={};for(var u in t)hasOwnProperty.call(t,u)&&(s[u]=t[u]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var l=2;l<a;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7832:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},metadata:function(){return u},toc:function(){return l},default:function(){return d}});var r=n(2122),o=n(9756),a=(n(7294),n(3905)),i=["components"],s={},u={unversionedId:"system/interview-questions",id:"system/interview-questions",isDocsHomePage:!1,title:"Interview Questions",description:"1. How to prevent double payment?",source:"@site/docs/system/4-interview-questions.md",sourceDirName:"system",slug:"/system/interview-questions",permalink:"/system/interview-questions",editUrl:"https://github.com/hhow09/hhow09.github.io/blob/source/docs/system/4-interview-questions.md",version:"current",sidebarPosition:4,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"The RUM Conjecture",permalink:"/system/db-rum"},next:{title:"Lighthouse Performance / Frontend Performance",permalink:"/web-dev/web-lighthouse-performance"}},l=[{value:"1. How to prevent double payment?",id:"1-how-to-prevent-double-payment",children:[{value:"Ref",id:"ref",children:[]},{value:"Solution 1: Database Level Lock",id:"solution-1-database-level-lock",children:[]},{value:"Solution 2: idempotency keys (w/o locking)",id:"solution-2-idempotency-keys-wo-locking",children:[]}]},{value:"2. What is the pros and cons of having Database index ?",id:"2-what-is-the-pros-and-cons-of-having-database-index-",children:[{value:"Pros",id:"pros",children:[]},{value:"Cons",id:"cons",children:[]}]},{value:"3. Pros and cons of denormalization",id:"3-pros-and-cons-of-denormalization",children:[]},{value:"4. 2 concurrent Read-then-update operation. How to prevent lost update ?",id:"4-2-concurrent-read-then-update-operation-how-to-prevent-lost-update-",children:[]},{value:"5. One to Many schema design",id:"5-one-to-many-schema-design",children:[]}],c={toc:l};function d(e){var t=e.components,n=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"1-how-to-prevent-double-payment"},"1. How to prevent double payment?"),(0,a.kt)("h3",{id:"ref"},"Ref"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://medium.com/airbnb-engineering/avoiding-double-payments-in-a-distributed-payments-system-2981f6b070bb"},"Avoiding Double Payments in a Distributed Payments System")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"http://www.zhuwu.me/blog/posts/lock-an-order-to-prevent-duplicate-payments-using-rdbms"},"Lock an Order to Prevent Duplicate Payments using RDBMS"))),(0,a.kt)("h3",{id:"solution-1-database-level-lock"},"Solution 1: Database Level Lock"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"BEGIN;\nSELECT * FROM order WHERE id = <order_id>  FOR UPDATE;\n# Check the order `paid` status:\n# If `paid` is equals to false, \n# process the payment, \n# and update `paid` to true upon successful payment\n  COMMIT;\n# Otherwise, a payment has been made, \n# so no further action is required.\n  ROLLBACK;\n")),(0,a.kt)("p",null,"This method solves the duplicate payments problem. However, since the requests blocked by the database lock occupy server resources forever until they successfully obtained the lock, it might become a performance bottleneck. The user also needs to wait for a long time if his/her payment request is contended for the lock, which results in a bad user experience."),(0,a.kt)("p",null,"Therefore, the following method aims to return earlier when payment contention is detected. Another table, order_mutex, is required:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"BEGIN;\n# try\n  INSERT INTO order_mutex VALUES (<order_id>);\n# Catch duplicate key error\n  ROLLBACK;\n# Otherwise, continue\n  COMMIT;\n\n# If order_mutex is inserted successfully\n  BEGIN;\n  # If `paid` is equals to false, \n  # process the payment, \n  # and update `paid` to true upon successful payment\n    COMMIT;\n  # Otherwise, a payment has been made, \n  # so no further action is required.\n    ROLLBACK;\n\n  BEGIN;\n  DELETE order_mutex WHERE order_id = <order_id>;\n  COMMIT;\n# Otherwise, return an error response to notify user \n# that another payment request is being processed.\n")),(0,a.kt)("h3",{id:"solution-2-idempotency-keys-wo-locking"},"Solution 2: idempotency keys (w/o locking)"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://stripe.com/docs/api/idempotent_requests"},"Stripe: Idempotent Requests")),(0,a.kt)("h2",{id:"2-what-is-the-pros-and-cons-of-having-database-index-"},"2. What is the pros and cons of having Database index ?"),(0,a.kt)("h3",{id:"pros"},"Pros"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If you don\u2019t create an index, the database scans all the rows, filters out the matching rows & returns the result."),(0,a.kt)("li",{parentName:"ul"},"Index is used to quicken the search by reducing the number of records to search for.")),(0,a.kt)("h3",{id:"cons"},"Cons"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"degrade write performance"),(0,a.kt)("li",{parentName:"ul"},"if using index on a ",(0,a.kt)("a",{parentName:"li",href:"https://dba.stackexchange.com/a/136676"},"high-cardinality column"),', the rate of change  from that column can be quite high. If that rate of change is faster than the updating of the index via the background process, then using an index is "inefficient".')),(0,a.kt)("h2",{id:"3-pros-and-cons-of-denormalization"},"3. Pros and cons of denormalization"),(0,a.kt)("h2",{id:"4-2-concurrent-read-then-update-operation-how-to-prevent-lost-update-"},"4. 2 concurrent Read-then-update operation. How to prevent lost update ?"),(0,a.kt)("h2",{id:"5-one-to-many-schema-design"},"5. One to Many schema design"),(0,a.kt)("p",null,"E.g. group chat user table, user follower table"))}d.isMDXComponent=!0}}]);